<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å³æ¢¦ API ç®¡ç†æ§åˆ¶å°</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      :root {
        --bg-primary: #0f0f23;
        --bg-secondary: #1a1a2e;
        --bg-card: #16213e;
        --text-primary: #e4e4e7;
        --text-secondary: #a1a1aa;
        --accent: #7c3aed;
        --accent-hover: #8b5cf6;
        --success: #10b981;
        --warning: #f59e0b;
        --error: #ef4444;
        --border: #27272a;
      }
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      /* Login/Setup Page */
      .auth-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }
      .auth-box {
        background: var(--bg-card);
        padding: 40px;
        border-radius: 16px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      }
      .auth-box h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 24px;
        background: linear-gradient(135deg, #7c3aed, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: var(--text-secondary);
        font-size: 14px;
      }
      .form-group input {
        width: 100%;
        padding: 12px 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 16px;
        transition: border-color 0.2s;
      }
      .form-group input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .btn {
        width: 100%;
        padding: 14px;
        background: var(--accent);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }
      .btn:hover {
        background: var(--accent-hover);
      }
      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .error-msg {
        color: var(--error);
        text-align: center;
        margin-top: 15px;
        font-size: 14px;
      }

      /* Dashboard */
      .dashboard {
        display: none;
      }
      .dashboard.active {
        display: block;
      }

      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid var(--border);
      }
      header h1 {
        font-size: 24px;
        background: linear-gradient(135deg, #7c3aed, #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .header-actions {
        display: flex;
        gap: 10px;
      }
      .header-actions button {
        padding: 8px 16px;
        background: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }
      .header-actions button:hover {
        border-color: var(--accent);
        color: var(--text-primary);
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 25px;
        background: var(--bg-secondary);
        padding: 4px;
        border-radius: 10px;
        width: fit-content;
      }
      .tab-btn {
        padding: 10px 24px;
        background: transparent;
        color: var(--text-secondary);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
      }
      .tab-btn.active {
        background: var(--accent);
        color: white;
      }
      .tab-btn:hover:not(.active) {
        color: var(--text-primary);
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Stats Cards */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: var(--bg-card);
        padding: 24px;
        border-radius: 12px;
        border: 1px solid var(--border);
      }
      .stat-card h3 {
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: 700;
        background: linear-gradient(135deg, #7c3aed, #3b82f6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      /* Tables */
      .table-container {
        background: var(--bg-card);
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
        margin-bottom: 25px;
      }
      .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid var(--border);
      }
      .table-header h3 {
        font-size: 16px;
        font-weight: 600;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 14px 20px;
        text-align: left;
        border-bottom: 1px solid var(--border);
      }
      th {
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      td {
        font-size: 14px;
      }
      tr:hover {
        background: rgba(124, 58, 237, 0.05);
      }

      /* Logs */
      .logs-toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .logs-toolbar select,
      .logs-toolbar button {
        padding: 8px 16px;
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 14px;
        cursor: pointer;
      }
      .log-container {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        max-height: 500px;
        overflow-y: auto;
      }
      .log-entry {
        padding: 10px 16px;
        border-bottom: 1px solid var(--border);
        font-family: "Monaco", "Consolas", monospace;
        font-size: 13px;
        display: flex;
        gap: 12px;
      }
      .log-entry:last-child {
        border-bottom: none;
      }
      .log-time {
        color: var(--text-secondary);
        min-width: 160px;
      }
      .log-level {
        min-width: 50px;
        font-weight: 600;
      }
      .log-level.INFO {
        color: var(--success);
      }
      .log-level.WARN {
        color: var(--warning);
      }
      .log-level.ERROR {
        color: var(--error);
      }
      .log-message {
        flex: 1;
        word-break: break-all;
      }

      /* Media Gallery */
      .media-filters {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      .media-filters button {
        padding: 8px 20px;
        background: var(--bg-card);
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
      }
      .media-filters button.active {
        background: var(--accent);
        color: white;
        border-color: var(--accent);
      }
      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }
      .media-item {
        background: var(--bg-card);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .media-item:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .media-thumb {
        width: 100%;
        height: 150px;
        object-fit: cover;
        background: var(--bg-secondary);
      }
      .media-info {
        padding: 12px;
      }
      .media-info .type {
        font-size: 11px;
        color: var(--accent);
        text-transform: uppercase;
        margin-bottom: 4px;
      }
      .media-info .date {
        font-size: 12px;
        color: var(--text-secondary);
      }
      .pagination {
        display: flex;
        justify-content: center;
        gap: 8px;
      }
      .pagination button {
        padding: 8px 16px;
        background: var(--bg-card);
        color: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 6px;
        cursor: pointer;
      }
      .pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
      .pagination span {
        padding: 8px 16px;
        color: var(--text-secondary);
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: var(--bg-card);
        padding: 30px;
        border-radius: 16px;
        max-width: 500px;
        width: 90%;
      }
      .modal-content h2 {
        margin-bottom: 20px;
      }
      .modal-close {
        float: right;
        background: none;
        border: none;
        color: var(--text-secondary);
        font-size: 24px;
        cursor: pointer;
      }

      /* Loading */
      .loading {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <!-- Auth Pages -->
    <div id="auth-page" class="auth-container">
      <div class="auth-box">
        <h1>ğŸ¨ å³æ¢¦ API æ§åˆ¶å°</h1>
        <div id="setup-form" style="display: none">
          <p
            style="
              text-align: center;
              color: var(--text-secondary);
              margin-bottom: 20px;
            "
          >
            é¦–æ¬¡ä½¿ç”¨ï¼Œè¯·è®¾ç½®ç®¡ç†å‘˜è´¦å·
          </p>
          <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="setup-username" placeholder="è®¾ç½®ç”¨æˆ·å" />
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input
              type="password"
              id="setup-password"
              placeholder="è®¾ç½®å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
            />
          </div>
          <button class="btn" onclick="handleSetup()">å®Œæˆè®¾ç½®</button>
          <div id="setup-error" class="error-msg"></div>
        </div>
        <div id="login-form" style="display: none">
          <div class="form-group">
            <label>ç”¨æˆ·å</label>
            <input type="text" id="login-username" placeholder="è¾“å…¥ç”¨æˆ·å" />
          </div>
          <div class="form-group">
            <label>å¯†ç </label>
            <input type="password" id="login-password" placeholder="è¾“å…¥å¯†ç " />
          </div>
          <button class="btn" onclick="handleLogin()">ç™» å½•</button>
          <div id="login-error" class="error-msg"></div>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard container">
      <header>
        <h1>ğŸ¨ å³æ¢¦ API ç®¡ç†æ§åˆ¶å°</h1>
        <div class="header-actions">
          <button onclick="showPasswordModal()">ä¿®æ”¹å¯†ç </button>
          <button onclick="handleLogout()">é€€å‡ºç™»å½•</button>
        </div>
      </header>

      <div class="tabs">
        <button class="tab-btn active" data-tab="stats">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</button>
        <button class="tab-btn" data-tab="logs">ğŸ“‹ å®æ—¶æ—¥å¿—</button>
        <button class="tab-btn" data-tab="media">ğŸ–¼ï¸ åª’ä½“åº“</button>
      </div>

      <!-- Stats Tab -->
      <div id="tab-stats" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>æ€»è°ƒç”¨æ¬¡æ•°</h3>
            <div class="value" id="total-calls">0</div>
          </div>
          <div class="stat-card">
            <h3>æ€»æ¶ˆè€—ç§¯åˆ†</h3>
            <div class="value" id="total-credits">0</div>
          </div>
          <div class="stat-card">
            <h3>æ´»è·ƒ Key æ•°</h3>
            <div class="value" id="active-keys">0</div>
          </div>
          <div class="stat-card">
            <h3>ä½¿ç”¨æ¨¡å‹æ•°</h3>
            <div class="value" id="models-used">0</div>
          </div>
        </div>

        <div class="table-container">
          <div class="table-header">
            <h3>API Key ä½¿ç”¨ç»Ÿè®¡</h3>
            <button
              onclick="loadStats()"
              style="
                padding: 6px 12px;
                background: var(--bg-secondary);
                border: 1px solid var(--border);
                border-radius: 4px;
                color: var(--text-secondary);
                cursor: pointer;
              "
            >
              åˆ·æ–°
            </button>
          </div>
          <table>
            <thead>
              <tr>
                <th>Key</th>
                <th>è°ƒç”¨æ¬¡æ•°</th>
                <th>æ¶ˆè€—ç§¯åˆ†</th>
                <th>å‰©ä½™ç§¯åˆ†</th>
                <th>æœ€åä½¿ç”¨</th>
              </tr>
            </thead>
            <tbody id="key-stats-table"></tbody>
          </table>
        </div>

        <div class="table-container">
          <div class="table-header"><h3>æ¨¡å‹ä½¿ç”¨ç»Ÿè®¡</h3></div>
          <table>
            <thead>
              <tr>
                <th>æ¨¡å‹</th>
                <th>è°ƒç”¨æ¬¡æ•°</th>
                <th>æ¶ˆè€—ç§¯åˆ†</th>
              </tr>
            </thead>
            <tbody id="model-stats-table"></tbody>
          </table>
        </div>
      </div>

      <!-- Logs Tab -->
      <div id="tab-logs" class="tab-content">
        <div class="logs-toolbar">
          <select id="log-level" onchange="loadLogs()">
            <option value="ALL">å…¨éƒ¨çº§åˆ«</option>
            <option value="INFO">INFO</option>
            <option value="WARN">WARN</option>
            <option value="ERROR">ERROR</option>
          </select>
          <button onclick="loadLogs()">ğŸ”„ åˆ·æ–°</button>
          <button onclick="clearLogs()">ğŸ—‘ï¸ æ¸…ç†æ—¥å¿—</button>
          <button onclick="exportLogs()">ğŸ“¥ å¯¼å‡º</button>
        </div>
        <div class="log-container" id="log-container">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>

      <!-- Media Tab -->
      <div id="tab-media" class="tab-content">
        <div class="media-filters">
          <button class="active" data-type="">å…¨éƒ¨</button>
          <button data-type="image">å›¾ç‰‡</button>
          <button data-type="video">è§†é¢‘</button>
        </div>
        <div class="media-grid" id="media-grid">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal">
      <div class="modal-content">
        <button class="modal-close" onclick="closePasswordModal()">
          &times;
        </button>
        <h2>ä¿®æ”¹å¯†ç </h2>
        <div class="form-group">
          <label>æ–°å¯†ç </label>
          <input
            type="password"
            id="new-password"
            placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰"
          />
        </div>
        <button class="btn" onclick="changePassword()">ç¡®è®¤ä¿®æ”¹</button>
        <div id="password-error" class="error-msg"></div>
      </div>
    </div>

    <script>
      let currentMediaPage = 1;
      let currentMediaType = "";
      let autoRefreshInterval;

      // Check auth status on load
      async function checkAuth() {
        try {
          const res = await fetch("/dashboard/status");
          const data = await res.json();

          if (!data.setupComplete) {
            document.getElementById("setup-form").style.display = "block";
            document.getElementById("login-form").style.display = "none";
          } else {
            document.getElementById("setup-form").style.display = "none";
            document.getElementById("login-form").style.display = "block";
            // Try to access dashboard
            const statsRes = await fetch("/dashboard/stats", { credentials: 'include' });
            if (statsRes.ok) {
              showDashboard();
            }
          }
        } catch (e) {
          console.error(e);
        }
      }

      async function handleSetup() {
        const username = document.getElementById("setup-username").value;
        const password = document.getElementById("setup-password").value;
        const errorEl = document.getElementById("setup-error");

        try {
          const res = await fetch("/dashboard/setup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
          });
          const data = await res.json();
          if (res.ok) {
            location.reload();
          } else {
            errorEl.textContent = data.error || "è®¾ç½®å¤±è´¥";
          }
        } catch (e) {
          errorEl.textContent = "è¯·æ±‚å¤±è´¥";
        }
      }

      async function handleLogin() {
        const username = document.getElementById("login-username").value;
        const password = document.getElementById("login-password").value;
        const errorEl = document.getElementById("login-error");

        try {
          const res = await fetch("/dashboard/login", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
            credentials: 'include'
          });
          const data = await res.json();
          if (res.ok) {
            showDashboard();
          } else {
            errorEl.textContent = data.error || "ç™»å½•å¤±è´¥";
          }
        } catch (e) {
          errorEl.textContent = "è¯·æ±‚å¤±è´¥";
        }
      }

      async function handleLogout() {
        await fetch("/dashboard/logout", { method: "POST", credentials: 'include' });
        location.reload();
      }

      function showDashboard() {
        document.getElementById("auth-page").style.display = "none";
        document.getElementById("dashboard").classList.add("active");
        loadStats();
        startAutoRefresh();
      }

      function startAutoRefresh() {
        autoRefreshInterval = setInterval(() => {
          const activeTab =
            document.querySelector(".tab-btn.active").dataset.tab;
          if (activeTab === "stats") loadStats();
          else if (activeTab === "logs") loadLogs();
        }, 10000);
      }

      // Tab switching
      document.querySelectorAll(".tab-btn").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".tab-btn")
            .forEach((b) => b.classList.remove("active"));
          document
            .querySelectorAll(".tab-content")
            .forEach((c) => c.classList.remove("active"));
          btn.classList.add("active");
          document
            .getElementById("tab-" + btn.dataset.tab)
            .classList.add("active");

          if (btn.dataset.tab === "logs") loadLogs();
          else if (btn.dataset.tab === "media") loadMedia();
        });
      });

      // Stats
      async function loadStats() {
        try {
          const res = await fetch("/dashboard/stats", { credentials: 'include' });
          if (!res.ok) return;
          const data = await res.json();

          document.getElementById("total-calls").textContent =
            data.totals?.total_calls || 0;
          document.getElementById("total-credits").textContent =
            data.totals?.total_credits || 0;
          document.getElementById("active-keys").textContent =
            data.keyStats?.length || 0;
          document.getElementById("models-used").textContent =
            data.modelStats?.length || 0;

          // Key stats table
          const keyTable = document.getElementById("key-stats-table");
          keyTable.innerHTML =
            data.keyStats
              ?.map(
                (k) => `
                    <tr>
                        <td><code>${k.key_preview}</code></td>
                        <td>${k.total_calls}</td>
                        <td>${k.total_credits}</td>
                        <td>${k.remaining_credits || 0}</td>
                        <td>${k.last_used || "-"}</td>
                    </tr>
                `
              )
              .join("") ||
            '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary)">æš‚æ— æ•°æ®</td></tr>';

          // Model stats table
          const modelTable = document.getElementById("model-stats-table");
          modelTable.innerHTML =
            data.modelStats
              ?.map(
                (m) => `
                    <tr>
                        <td>${m.model}</td>
                        <td>${m.total_calls}</td>
                        <td>${m.total_credits}</td>
                    </tr>
                `
              )
              .join("") ||
            '<tr><td colspan="3" style="text-align:center;color:var(--text-secondary)">æš‚æ— æ•°æ®</td></tr>';
        } catch (e) {
          console.error(e);
        }
      }

      // Logs
      async function loadLogs() {
        const level = document.getElementById("log-level").value;
        try {
          const res = await fetch(`/dashboard/logs?level=${level}&limit=200`, { credentials: 'include' });
          if (!res.ok) return;
          const logs = await res.json();

          const container = document.getElementById("log-container");
          container.innerHTML =
            logs
              .map(
                (log) => `
                    <div class="log-entry">
                        <span class="log-time">${log.created_at}</span>
                        <span class="log-level ${log.level}">${log.level}</span>
                        <span class="log-message">${escapeHtml(
                          log.message
                        )}</span>
                    </div>
                `
              )
              .join("") || '<div class="loading">æš‚æ— æ—¥å¿—</div>';
        } catch (e) {
          console.error(e);
        }
      }

      async function clearLogs() {
        if (!confirm("ç¡®å®šè¦æ¸…ç†æ‰€æœ‰æ—¥å¿—å—ï¼Ÿ")) return;
        await fetch("/dashboard/logs", { method: "DELETE", credentials: 'include' });
        loadLogs();
      }

      function exportLogs() {
        const container = document.getElementById("log-container");
        const text = container.innerText;
        const blob = new Blob([text], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `jimeng-logs-${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
      }

      // Media
      document.querySelectorAll(".media-filters button").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".media-filters button")
            .forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentMediaType = btn.dataset.type;
          currentMediaPage = 1;
          loadMedia();
        });
      });

      async function loadMedia() {
        try {
          const url = `/dashboard/media?page=${currentMediaPage}&limit=20${
            currentMediaType ? "&type=" + currentMediaType : ""
          }`;
          const res = await fetch(url, { credentials: 'include' });
          if (!res.ok) return;
          const data = await res.json();

          const grid = document.getElementById("media-grid");
          if (data.items.length === 0) {
            grid.innerHTML = '<div class="loading">æš‚æ— åª’ä½“</div>';
          } else {
            grid.innerHTML = data.items
              .map(
                (item) => `
                        <div class="media-item" onclick="window.open('${
                          item.url
                        }', '_blank')">
                            ${item.type === "image" 
                              ? `<img class="media-thumb" src="${item.url}" onerror="this.style.background='var(--bg-secondary)'" alt="å›¾ç‰‡">`
                              : `<div class="media-thumb" style="display:flex;align-items:center;justify-content:center;background:var(--bg-secondary);color:var(--text-secondary);font-size:32px;">ğŸ¬</div>`
                            }
                            <div class="media-info">
                                <div class="type">${
                                  item.type === "image" ? "å›¾ç‰‡" : "è§†é¢‘"
                                }</div>
                                <div class="date">${item.created_at}</div>
                            </div>
                        </div>
                    `
              )
              .join("");
          }

          // Pagination
          const pagination = document.getElementById("pagination");
          pagination.innerHTML = `
                    <button ${
                      data.page <= 1 ? "disabled" : ""
                    } onclick="changePage(${data.page - 1})">ä¸Šä¸€é¡µ</button>
                    <span>${data.page} / ${data.totalPages || 1}</span>
                    <button ${
                      data.page >= data.totalPages ? "disabled" : ""
                    } onclick="changePage(${data.page + 1})">ä¸‹ä¸€é¡µ</button>
                `;
        } catch (e) {
          console.error(e);
        }
      }

      function changePage(page) {
        currentMediaPage = page;
        loadMedia();
      }

      // Password
      function showPasswordModal() {
        document.getElementById("password-modal").classList.add("active");
      }
      function closePasswordModal() {
        document.getElementById("password-modal").classList.remove("active");
      }
      async function changePassword() {
        const newPassword = document.getElementById("new-password").value;
        const errorEl = document.getElementById("password-error");
        try {
          const res = await fetch("/dashboard/password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ newPassword }),
            credentials: 'include'
          });
          const data = await res.json();
          if (res.ok) {
            alert("å¯†ç ä¿®æ”¹æˆåŠŸ");
            closePasswordModal();
          } else {
            errorEl.textContent = data.error;
          }
        } catch (e) {
          errorEl.textContent = "è¯·æ±‚å¤±è´¥";
        }
      }

      function escapeHtml(str) {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      }

      // Init
      checkAuth();
    </script>
  </body>
</html>
